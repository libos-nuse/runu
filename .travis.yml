language: go
go:
  - "1.11.x"

cache:
  directories:
    - $HOME/.ccache

env:
  - DOCKER_IMG_VERSION=0.1

matrix:
  include:
    - os: linux
      cache:
        directories:
          - $HOME/.cache/go-build
      dist: trusty
      sudo: required
      before_install:
        - sudo apt-get install jq
    - os: osx
      osx_image: xcode10.1
      cache:
        directories:
          - $HOME/Library/Caches/go-build
      before_install:
        - HOMEBREW_NO_AUTO_UPDATE=1 brew install jq
        - HOMEBREW_NO_AUTO_UPDATE=1 brew cask info tuntap
        - HOMEBREW_NO_AUTO_UPDATE=1 brew install ukontainer/lkl/dockerd-darwin
        - mkdir -p ~/.local/bin
        - export PATH=/usr/local/opt/ccache/libexec:$HOME/.local/bin:$PATH
        - ln -sf /usr/local/bin/gsha256sum ~/.local/bin/sha256sum
    - os: osx
      osx_image: xcode10.2
      cache:
        directories:
          - $HOME/Library/Caches/go-build
      before_install:
        - HOMEBREW_NO_AUTO_UPDATE=1 brew install jq
        - HOMEBREW_NO_AUTO_UPDATE=1 brew cask info tuntap
        - HOMEBREW_NO_AUTO_UPDATE=1 brew install ukontainer/lkl/dockerd-darwin
        - mkdir -p ~/.local/bin
        - export PATH=/usr/local/opt/ccache/libexec:$HOME/.local/bin:$PATH
        - ln -sf /usr/local/bin/gsha256sum ~/.local/bin/sha256sum

before_script:
  - go get -u github.com/gojp/goreportcard/cmd/goreportcard-cli
  - go get -u github.com/alecthomas/gometalinter
  - go get -u github.com/gordonklaus/ineffassign
  - go get -u github.com/fzipp/gocyclo
  - go get -u github.com/client9/misspell/cmd/misspell
  - go get -u golang.org/x/lint/golint

script:
  - goreportcard-cli -t 100.0 -v
  - bash -ex test/standalone-test.sh
  - bash -ex test/docker-oci-test.sh
  - bash -ex test/containerd-ctr-test.sh

